<!-- cleanUpProcess BPEL Process [Generated by the Eclipse BPEL Designer]  -->
<!-- Date: Wed Apr 30 20:46:09 CEST 2014 -->

<bpel:process name="cleanUpProcess"
         targetNamespace="http://bpel4mobile.com/example/hotel/schemas"
         suppressJoinFailure="yes"
         xmlns:tns="http://bpel4mobile.com/example/hotel/schemas"
         xmlns:bpel="http://docs.oasis-open.org/wsbpel/2.0/process/executable"
         xmlns:ns="http://bpel4mobile.com/schemas" xmlns:ns1="http://www.w3.org/2001/XMLSchema"
         xmlns:ns2="http://bpel4mobile.com/schemas/example/verifyService">
    <!-- Import the client WSDL -->
    <bpel:import namespace="http://bpel4mobile.com/schemas" location="cleanUpService.wsdl" importType="http://schemas.xmlsoap.org/wsdl/">
    </bpel:import>
    <bpel:import location="cleanUpProcessArtifacts.wsdl" namespace="http://bpel4mobile.com/example/hotel/schemas" 
	        importType="http://schemas.xmlsoap.org/wsdl/" />
	        
    <!-- ================================================================= -->         
    <!-- PARTNERLINKS                                                      -->
    <!-- List of services participating in this BPEL process               -->
    <!-- ================================================================= -->         
    <bpel:partnerLinks>
        <!--
        The 'client' role represents the requester of this service. It is 
        used for callback. The location and correlation information associated
        with the client role are automatically set using WS-Addressing.
        -->
        <bpel:partnerLink name="client"
                     partnerLinkType="tns:cleanUpProcess"
                     myRole="cleanUpProcessProvider"
                     partnerRole="cleanUpProcessRequester"
                     />
        <bpel:partnerLink name="cleanUpServicePL" partnerLinkType="tns:cleanUpServicePL" partnerRole="cleanUpServiceRole"></bpel:partnerLink>
        <bpel:partnerLink name="verifyTaskPL" partnerLinkType="tns:verifyTaskPL" partnerRole="verifyTaskPort"></bpel:partnerLink>
    </bpel:partnerLinks>
  
    <!-- ================================================================= -->         
    <!-- VARIABLES                                                         -->
    <!-- List of messages and XML documents used within this BPEL process  -->
    <!-- ================================================================= -->         
    <bpel:variables>
        <!-- Reference to the message passed as input during initiation -->
        <bpel:variable name="input"
                  messageType="tns:cleanUpProcessRequestMessage"/>
                  
        <!-- Reference to the message that will be sent back to the 
             requester during callback
             -->
        <bpel:variable name="output"
                  messageType="tns:cleanUpProcessResponseMessage"/>
        <bpel:variable name="cleanUpServicePLResponse" messageType="ns:TaskResponse"></bpel:variable>
        <bpel:variable name="cleanUpServicePLRequest" messageType="ns:CleanUpTaskRequest"></bpel:variable>
        <bpel:variable name="clientRequest" messageType="tns:cleanUpTaskCallbackRequest"></bpel:variable>
        
        
        
        
        <bpel:variable name="verifyTaskPLResponse1" messageType="ns2:TaskResponse"></bpel:variable>
        <bpel:variable name="verifyTaskPLRequest1" messageType="ns2:VerifyTaskRequest"></bpel:variable>
        <bpel:variable name="clientRequest1" messageType="tns:verifyTaskCallbackRequest"></bpel:variable>
        <bpel:variable name="verificationStatus" type="ns1:string"></bpel:variable>
    </bpel:variables>

    <!-- ================================================================= -->         
    <!-- ORCHESTRATION LOGIC                                               -->
    <!-- Set of activities coordinating the flow of messages across the    -->
    <!-- services integrated within this business process                  -->
    <!-- ================================================================= -->         
    <bpel:correlationSets>
        <bpel:correlationSet name="cleanUpTask" properties="tns:taskUUID"></bpel:correlationSet>
        <bpel:correlationSet name="verifyTask" properties="tns:verifyTaskUUID"></bpel:correlationSet>
    </bpel:correlationSets>
    <bpel:sequence name="main">
        <!-- Receive input from requestor. 
             Note: This maps to operation defined in cleanUpProcess.wsdl 
             --><bpel:receive name="receiveInput" partnerLink="client" portType="tns:cleanUpProcess" operation="initiate" variable="input" createInstance="yes" />
        
        <!-- Asynchronous callback to the requester.
             Note: the callback location and correlation id is transparently handled 
             using WS-addressing.
             -->
        <bpel:repeatUntil name="RepeatUntil">
            <bpel:sequence>
                <bpel:assign validate="no" name="prepareCleanUpTaskRequest">
            <bpel:copy>
                <bpel:from><bpel:literal><tns:CleanUpTaskRequest xmlns:tns="http://bpel4mobile.com/schemas" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
					  <tns:callbackUrl>tns:callbackUrl</tns:callbackUrl>
					  <tns:request>
					    <tns:deadline>2001-12-31T12:00:00</tns:deadline>
					    <tns:room>
					      <tns:id>0</tns:id>
					      <tns:number>0</tns:number>
					      <tns:floor>0</tns:floor>
					      <tns:category>
					        <tns:name>tns:name</tns:name>
					        <tns:standard>0</tns:standard>
					      </tns:category>
					    </tns:room>
					  </tns:request>
					</tns:CleanUpTaskRequest>
					</bpel:literal></bpel:from>
                <bpel:to variable="cleanUpServicePLRequest" part="CleanUpTaskRequest"></bpel:to>
            </bpel:copy>
            <bpel:copy>
                <bpel:from part="payload" variable="input">
                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[tns:deadline]]></bpel:query>
                </bpel:from>
                <bpel:to part="CleanUpTaskRequest" variable="cleanUpServicePLRequest">
                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[ns:request/ns:deadline]]></bpel:query>
                </bpel:to>
            </bpel:copy>
            <bpel:copy>
                <bpel:from part="payload" variable="input">
                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[tns:room/tns:id]]></bpel:query>
                </bpel:from>
                <bpel:to part="CleanUpTaskRequest" variable="cleanUpServicePLRequest">
                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[ns:request/ns:room/ns:id]]></bpel:query>
                </bpel:to>
            </bpel:copy>
            <bpel:copy>
                <bpel:from part="payload" variable="input">
                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[tns:room/tns:number]]></bpel:query>
                </bpel:from>
                <bpel:to part="CleanUpTaskRequest" variable="cleanUpServicePLRequest">
                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[ns:request/ns:room/ns:number]]></bpel:query>
                </bpel:to>
            </bpel:copy>
            <bpel:copy>
                <bpel:from part="payload" variable="input">
                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[tns:room/tns:floor]]></bpel:query>
                </bpel:from>
                <bpel:to part="CleanUpTaskRequest" variable="cleanUpServicePLRequest">
                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[ns:request/ns:room/ns:floor]]></bpel:query>
                </bpel:to>
            </bpel:copy>
            <bpel:copy>
                <bpel:from part="payload" variable="input">
                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[tns:room/tns:category/tns:name]]></bpel:query>
                </bpel:from>
                <bpel:to part="CleanUpTaskRequest" variable="cleanUpServicePLRequest">
                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[ns:request/ns:room/ns:category/ns:name]]></bpel:query>
                </bpel:to>
            </bpel:copy>
            <bpel:copy>
                <bpel:from part="payload" variable="input">
                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[tns:room/tns:category/tns:standard]]></bpel:query>
                </bpel:from>
                <bpel:to part="CleanUpTaskRequest" variable="cleanUpServicePLRequest">
                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[ns:request/ns:room/ns:category/ns:standard]]></bpel:query>
                </bpel:to>
            </bpel:copy>
            <bpel:copy>
                <bpel:from partnerLink="client" endpointReference="myRole"></bpel:from>
                <bpel:to part="CleanUpTaskRequest" variable="cleanUpServicePLRequest">
                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                        <![CDATA[ns:callbackUrl]]>
                    </bpel:query>
                </bpel:to>
            </bpel:copy>
        </bpel:assign>
                <bpel:invoke name="createCleanUpTask" partnerLink="cleanUpServicePL" operation="CleanUpTask" portType="ns:cleanUpServicePort" inputVariable="cleanUpServicePLRequest" outputVariable="cleanUpServicePLResponse">
                <bpel:correlations>
	                <bpel:correlation set="cleanUpTask" initiate="join" pattern="response"></bpel:correlation>
	            </bpel:correlations>
        
                </bpel:invoke>
                <bpel:receive name="recieveCleanUpTaskResult" partnerLink="client" operation="cleanUpTaskCallback" portType="tns:cleanUpProcess" variable="clientRequest">
            <bpel:correlations>
                <bpel:correlation set="cleanUpTask" initiate="no"></bpel:correlation>    
            </bpel:correlations>
        
                </bpel:receive>
                <bpel:assign validate="no" name="prepareVerifyTaskRequest"><bpel:copy>
                <bpel:from><bpel:literal><tns:VerifyTaskRequest xmlns:tns="http://bpel4mobile.com/schemas/example/verifyService" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <tns:callbackUrl>tns:callbackUrl</tns:callbackUrl>
  <tns:request>
    <tns:deadline>2001-12-31T12:00:00</tns:deadline>
    <tns:cleanUpPerformer>tns:cleanUpPerformer</tns:cleanUpPerformer>
    <tns:room>
      <tns:id>0</tns:id>
      <tns:number>0</tns:number>
      <tns:floor>0</tns:floor>
      <tns:category>
        <tns:name>tns:name</tns:name>
        <tns:standard>0</tns:standard>
      </tns:category>
    </tns:room>
  </tns:request>
</tns:VerifyTaskRequest>
</bpel:literal></bpel:from>
                <bpel:to part="VerifyTaskRequest" variable="verifyTaskPLRequest1"></bpel:to>
            </bpel:copy>
            <bpel:copy>
                <bpel:from part="payload" variable="input">
                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                        <![CDATA[tns:deadline]]>
                    </bpel:query>
                </bpel:from>
                <bpel:to part="VerifyTaskRequest" variable="verifyTaskPLRequest1">
                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                        <![CDATA[ns2:request/ns2:deadline]]>
                    </bpel:query>
                </bpel:to>
            </bpel:copy>
            
                <bpel:copy>
	                <bpel:from part="parameters" variable="clientRequest">
	                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[tns:resolver]]></bpel:query>
	                </bpel:from>
	                <bpel:to part="VerifyTaskRequest" variable="verifyTaskPLRequest1">
		                <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
		                        <![CDATA[ns2:request/ns2:cleanUpPerformer]]>
	                    </bpel:query>
	                </bpel:to>
	            </bpel:copy>
            <bpel:copy>
                <bpel:from part="payload" variable="input">
                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[tns:room/tns:id]]></bpel:query>
                </bpel:from>
                <bpel:to part="VerifyTaskRequest" variable="verifyTaskPLRequest1">
                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                        <![CDATA[ns2:request/ns2:room/ns2:id]]>
                    </bpel:query>
                </bpel:to>
            </bpel:copy>
            <bpel:copy>
                <bpel:from part="payload" variable="input">
                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[tns:room/tns:number]]></bpel:query>
                </bpel:from>
                <bpel:to part="VerifyTaskRequest" variable="verifyTaskPLRequest1">
                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                        <![CDATA[ns2:request/ns2:room/ns2:number]]>
                    </bpel:query>
                </bpel:to>
            </bpel:copy>
            <bpel:copy>
                <bpel:from part="payload" variable="input">
                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                        <![CDATA[tns:room/tns:floor]]>
                    </bpel:query>
                </bpel:from>
                <bpel:to part="VerifyTaskRequest" variable="verifyTaskPLRequest1">
                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                        <![CDATA[ns2:request/ns2:room/ns2:floor]]>
                    </bpel:query>
                </bpel:to>
            </bpel:copy>
            <bpel:copy>
                <bpel:from part="payload" variable="input">
                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                        <![CDATA[tns:room/tns:category/tns:name]]>
                    </bpel:query>
                </bpel:from>
                <bpel:to part="VerifyTaskRequest" variable="verifyTaskPLRequest1">
                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                        <![CDATA[ns2:request/ns2:room/ns2:category/ns2:name]]>
                    </bpel:query>
                </bpel:to>
            </bpel:copy>
            <bpel:copy>
                <bpel:from part="payload" variable="input">
                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                        <![CDATA[tns:room/tns:category/tns:standard]]>
                    </bpel:query>
                </bpel:from>
                <bpel:to part="VerifyTaskRequest" variable="verifyTaskPLRequest1">
                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                        <![CDATA[ns2:request/ns2:room/ns2:category/ns2:standard]]>
                    </bpel:query>
                </bpel:to>
            </bpel:copy>
            <bpel:copy>
                <bpel:from partnerLink="client" endpointReference="myRole"></bpel:from>
                <bpel:to part="VerifyTaskRequest" variable="verifyTaskPLRequest1">
                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                        <![CDATA[ns2:callbackUrl]]>
                    </bpel:query>
                </bpel:to>
            </bpel:copy>
        
                </bpel:assign>
                <bpel:invoke name="createVerifyTask" partnerLink="verifyTaskPL" operation="VerifyTask" portType="ns2:verifyServicePort" inputVariable="verifyTaskPLRequest1" outputVariable="verifyTaskPLResponse1"><bpel:correlations>
                <bpel:correlation set="verifyTask" initiate="join" pattern="response"></bpel:correlation>
            </bpel:correlations>
        
                </bpel:invoke>
                <bpel:receive name="recieveVerifyTaskResult" partnerLink="client" operation="verifyTaskCallback" portType="tns:cleanUpProcess" variable="clientRequest1"><bpel:correlations>
                <bpel:correlation set="verifyTask" initiate="no"></bpel:correlation>
            </bpel:correlations>
        
                </bpel:receive>
                <bpel:assign validate="no" name="retrievVerificationStatus">
                    <bpel:copy>
                        <bpel:from part="parameters" variable="clientRequest1">
                            <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[tns:result/tns:status]]></bpel:query>
                        </bpel:from>
                        <bpel:to variable="verificationStatus"></bpel:to>
                    </bpel:copy>
                    
                </bpel:assign>
            </bpel:sequence>
            <bpel:condition expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[$verificationStatus = 'success']]></bpel:condition>
        </bpel:repeatUntil>
        
        
        
        
        
        
        <bpel:assign validate="no" name="prepareResponse">
            <bpel:copy>
                <bpel:from><bpel:literal><tns:cleanUpResponse xmlns:tns="http://bpel4mobile.com/example/hotel/schemas" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <tns:status>tns:status</tns:status>
  <tns:room>
    <tns:id>0</tns:id>
  </tns:room>
</tns:cleanUpResponse>
</bpel:literal></bpel:from>
                <bpel:to variable="output" part="payload"></bpel:to>
            </bpel:copy>
            <bpel:copy>
                <bpel:from part="payload" variable="input">
                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[tns:room/tns:id]]></bpel:query>
                </bpel:from>
                <bpel:to part="payload" variable="output">
                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[tns:room/tns:id]]></bpel:query>
                </bpel:to>
            </bpel:copy>
            <bpel:copy>
                <bpel:from>
                    <bpel:literal xml:space="preserve">success</bpel:literal>
                </bpel:from>
                <bpel:to part="payload" variable="output">
                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[tns:status]]></bpel:query>
                </bpel:to>
            </bpel:copy>
            
        </bpel:assign>
        <bpel:invoke name="callbackClient" partnerLink="client" portType="tns:cleanUpProcessCallback" operation="onResult" inputVariable="output" />
    
    
    </bpel:sequence>
</bpel:process>

